# HÆ°á»›ng dáº«n Deploy Backend EduScan

## Deploy Backend Ä‘Æ¡n giáº£n (khÃ´ng Docker)

Script `deploy-backend-simple.sh` sáº½ deploy backend FastAPI vá»›i cÃ¡c tÃ­nh nÄƒng:

- âœ… Python virtual environment
- âœ… PostgreSQL database
- âœ… Nginx reverse proxy
- âœ… SSL/HTTPS vá»›i Let's Encrypt  
- âœ… Systemd service
- âœ… CORS enabled
- âœ… Auto SSL renewal

### CÃ¡ch sá»­ dá»¥ng

#### 1. Deploy vá»›i IP address (HTTP only)
```bash
sudo ./deploy-backend-simple.sh
```

#### 2. Deploy vá»›i domain (HTTPS enabled)
```bash
sudo ./deploy-backend-simple.sh your-domain.com your-email@domain.com
```

VÃ­ dá»¥:
```bash
sudo ./deploy-backend-simple.sh eduscan.id.vn admin@eduscan.id.vn
```

### Sau khi deploy

#### Quáº£n lÃ½ backend
```bash
cd /root/projects/Eduscan

# Xem tráº¡ng thÃ¡i
./manage-backend.sh status

# Xem logs
./manage-backend.sh logs

# Restart service
./manage-backend.sh restart

# Test API
./manage-backend.sh test

# Update code
./manage-backend.sh update

# Backup database
./manage-backend.sh backup

# Renew SSL certificate
./manage-backend.sh ssl-renew
```

#### Truy cáº­p API

- **API Base URL**: `http://your-domain/api/v1/` hoáº·c `https://your-domain/api/v1/`
- **API Documentation**: `http://your-domain/docs` hoáº·c `https://your-domain/docs`
- **Health Check**: `http://your-domain/api/v1/health`

#### Kiá»ƒm tra services

```bash
# Backend service
sudo systemctl status eduscan-backend

# Nginx service  
sudo systemctl status nginx

# PostgreSQL service
sudo systemctl status postgresql

# Xem logs backend
sudo journalctl -u eduscan-backend -f

# Xem logs nginx
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### Cáº¥u hÃ¬nh Environment

File `.env` Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng táº¡i `/root/projects/Eduscan/backend/.env`:

```env
DATABASE_URL=postgresql://eduscan_user:eduscan_password@localhost:5432/eduscan_db
SECRET_KEY=<auto-generated>
CORS_ORIGINS=https://your-domain,http://your-domain
UPLOAD_DIR=/var/lib/eduscan/uploads
OMR_DATA_DIR=/var/lib/eduscan/omr
```

### Cáº¥u trÃºc thÆ° má»¥c

```
/root/projects/Eduscan/
â”œâ”€â”€ backend/                    # Backend source code
â”‚   â”œâ”€â”€ venv/                  # Python virtual environment
â”‚   â”œâ”€â”€ .env                   # Environment variables
â”‚   â””â”€â”€ app/                   # FastAPI application
â”œâ”€â”€ manage-backend.sh          # Management script
â””â”€â”€ deploy-backend-simple.sh   # Deployment script

/var/lib/eduscan/
â”œâ”€â”€ uploads/                   # Uploaded files
â”œâ”€â”€ omr/                       # OMR data
â””â”€â”€ backups/                   # Database backups

/etc/systemd/system/
â””â”€â”€ eduscan-backend.service    # Systemd service

/etc/nginx/sites-available/
â””â”€â”€ eduscan                    # Nginx configuration
```

### Troubleshooting

#### Backend khÃ´ng start
```bash
# Kiá»ƒm tra logs
sudo journalctl -u eduscan-backend -f

# Kiá»ƒm tra cáº¥u hÃ¬nh
sudo systemctl status eduscan-backend

# Restart service
sudo systemctl restart eduscan-backend
```

#### Database connection error
```bash
# Kiá»ƒm tra PostgreSQL
sudo systemctl status postgresql

# Kiá»ƒm tra user vÃ  database
sudo -u postgres psql -c "\du"
sudo -u postgres psql -c "\l"

# Reset database (náº¿u cáº§n)
sudo -u postgres dropdb eduscan_db
sudo -u postgres createdb -O eduscan_user eduscan_db
```

#### SSL certificate issues
```bash
# Renew certificate
sudo certbot renew

# Check certificate status
sudo certbot certificates

# Force renew
sudo certbot renew --force-renewal
```

#### Port conflicts
```bash
# Kiá»ƒm tra port Ä‘ang sá»­ dá»¥ng
sudo netstat -tlnp | grep :8000
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# Kill process náº¿u cáº§n
sudo kill <PID>
```

### Performance Tuning

#### TÄƒng sá»‘ workers cho production
Edit file `/etc/systemd/system/eduscan-backend.service`:
```ini
ExecStart=/root/projects/Eduscan/backend/venv/bin/uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 8
```

Sau Ä‘Ã³ restart:
```bash
sudo systemctl daemon-reload
sudo systemctl restart eduscan-backend
```

#### Nginx caching
ThÃªm vÃ o `/etc/nginx/sites-available/eduscan`:
```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### Security Notes

- ğŸ”’ SSL certificate tá»± Ä‘á»™ng renew
- ğŸ”‘ Secret key Ä‘Æ°á»£c generate tá»± Ä‘á»™ng
- ğŸ›¡ï¸ CORS Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘Ãºng
- ğŸš« Default nginx site bá»‹ disable
- ğŸ“ ThÆ° má»¥c uploads cÃ³ quyá»n phÃ¹ há»£p 