# Hướng dẫn Deploy Backend EduScan

## Deploy Backend đơn giản (không Docker)

Script `deploy-backend-simple.sh` sẽ deploy backend FastAPI với các tính năng:

- ✅ Python virtual environment
- ✅ PostgreSQL database
- ✅ Nginx reverse proxy
- ✅ SSL/HTTPS với Let's Encrypt  
- ✅ Systemd service
- ✅ CORS enabled
- ✅ Auto SSL renewal

### Cách sử dụng

#### 1. Deploy với IP address (HTTP only)
```bash
sudo ./deploy-backend-simple.sh
```

#### 2. Deploy với domain (HTTPS enabled)
```bash
sudo ./deploy-backend-simple.sh your-domain.com your-email@domain.com
```

Ví dụ:
```bash
sudo ./deploy-backend-simple.sh eduscan.id.vn admin@eduscan.id.vn
```

### Sau khi deploy

#### Quản lý backend
```bash
cd /root/projects/Eduscan

# Xem trạng thái
./manage-backend.sh status

# Xem logs
./manage-backend.sh logs

# Restart service
./manage-backend.sh restart

# Test API
./manage-backend.sh test

# Update code
./manage-backend.sh update

# Backup database
./manage-backend.sh backup

# Renew SSL certificate
./manage-backend.sh ssl-renew
```

#### Truy cập API

- **API Base URL**: `http://your-domain/api/v1/` hoặc `https://your-domain/api/v1/`
- **API Documentation**: `http://your-domain/docs` hoặc `https://your-domain/docs`
- **Health Check**: `http://your-domain/api/v1/health`

#### Kiểm tra services

```bash
# Backend service
sudo systemctl status eduscan-backend

# Nginx service  
sudo systemctl status nginx

# PostgreSQL service
sudo systemctl status postgresql

# Xem logs backend
sudo journalctl -u eduscan-backend -f

# Xem logs nginx
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### Cấu hình Environment

File `.env` được tạo tự động tại `/root/projects/Eduscan/backend/.env`:

```env
DATABASE_URL=postgresql://eduscan_user:eduscan_password@localhost:5432/eduscan_db
SECRET_KEY=<auto-generated>
CORS_ORIGINS=https://your-domain,http://your-domain
UPLOAD_DIR=/var/lib/eduscan/uploads
OMR_DATA_DIR=/var/lib/eduscan/omr
```

### Cấu trúc thư mục

```
/root/projects/Eduscan/
├── backend/                    # Backend source code
│   ├── venv/                  # Python virtual environment
│   ├── .env                   # Environment variables
│   └── app/                   # FastAPI application
├── manage-backend.sh          # Management script
└── deploy-backend-simple.sh   # Deployment script

/var/lib/eduscan/
├── uploads/                   # Uploaded files
├── omr/                       # OMR data
└── backups/                   # Database backups

/etc/systemd/system/
└── eduscan-backend.service    # Systemd service

/etc/nginx/sites-available/
└── eduscan                    # Nginx configuration
```

### Troubleshooting

#### Backend không start
```bash
# Kiểm tra logs
sudo journalctl -u eduscan-backend -f

# Kiểm tra cấu hình
sudo systemctl status eduscan-backend

# Restart service
sudo systemctl restart eduscan-backend
```

#### Database connection error
```bash
# Kiểm tra PostgreSQL
sudo systemctl status postgresql

# Kiểm tra user và database
sudo -u postgres psql -c "\du"
sudo -u postgres psql -c "\l"

# Reset database (nếu cần)
sudo -u postgres dropdb eduscan_db
sudo -u postgres createdb -O eduscan_user eduscan_db
```

#### SSL certificate issues
```bash
# Renew certificate
sudo certbot renew

# Check certificate status
sudo certbot certificates

# Force renew
sudo certbot renew --force-renewal
```

#### Port conflicts
```bash
# Kiểm tra port đang sử dụng
sudo netstat -tlnp | grep :8000
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# Kill process nếu cần
sudo kill <PID>
```

### Performance Tuning

#### Tăng số workers cho production
Edit file `/etc/systemd/system/eduscan-backend.service`:
```ini
ExecStart=/root/projects/Eduscan/backend/venv/bin/uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 8
```

Sau đó restart:
```bash
sudo systemctl daemon-reload
sudo systemctl restart eduscan-backend
```

#### Nginx caching
Thêm vào `/etc/nginx/sites-available/eduscan`:
```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### Security Notes

- 🔒 SSL certificate tự động renew
- 🔑 Secret key được generate tự động
- 🛡️ CORS được cấu hình đúng
- 🚫 Default nginx site bị disable
- 📁 Thư mục uploads có quyền phù hợp 